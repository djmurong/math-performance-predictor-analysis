---
title: "EDA"
fig-width: 8
fig-asp: 0.618
---

```{r}
#| label: load-packages
library(tidyverse)
library(tidymodels)
library(readxl)
```

```{r}
#| label: load-data
edu_achievement <- read_excel(
  "data/educationachievement.xlsx",
  skip = 1
)
glimpse(edu_achievement)
```

```{r}
#| label: pivot-longer
edu_achievement_longer <- edu_achievement |>
  pivot_longer(
    cols = c("Dalc", "Walc"),
    names_to = "alc_type",
    values_to = "alc_lvl"
  )
```

@fig-g3-failures highlights differences in medians of students' final grades across the number of past class fails they have.
```{r}
#| label: fig-g3-failures
#| fig-cap: Final Grade vs. Number of Past Class Failures
ggplot(edu_achievement, aes(x = failures, y = G3, group = failures, color = failures)) +
  geom_boxplot() +
  labs(
    title = "Final Grade vs Number of Past Class Failures",
    x = "Number of Past Class Failures",
    y = "Final Grade"
  ) +
  theme(legend.position = "none")
```

```{r}
#| label: fig-wacl-dalc-g3
new_labels <- c("Dalc" = "Weekday", "Walc" = "Weekend")

edu_achievement_longer |>
  mutate(
    alc_type = fct_relevel(alc_type, c("Dalc", "Walc"))
  ) |>
ggplot(aes(x = alc_lvl, y = G3, group = alc_lvl, color = alc_lvl)) +
  geom_boxplot() +
  facet_grid(rows = vars(alc_type), labeller = labeller(.rows = new_labels)) +
  labs(
    title = "Final Grade vs Alcoholic Consumption Level",
    subtitle = "Separated by Weekday and Weekend",
    x = "Alcoholic Consumption Level",
    y = "Final Grade"
  ) +
  theme(legend.position = "none")
```

```{r}
#| label: fig-medu-g3
#| layout-nrow: 2
ggplot(edu_achievement, aes(x = Medu, y = G3)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  labs(
    x = "Mother’s Education Level",
    y = "Final Grade (1-20)",
    title = "Final Grade of Students Based on Mother’s Education Level",
    subtitle = "Student Serformance in Math in the Portugueuse schools of 
Gabriel Pereira and Mousinho da Silveira"
  )

ggplot(edu_achievement, aes(x = Fedu, y = G3)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  labs(
    x = "Father’s Education Level",
    y = "Final Grade (1-20)",
    title = "Final Grade of Students Based on Father’s Education Level",
    subtitle = "Student Serformance in Math in the Portugueuse schools of 
Gabriel Pereira and Mousinho da Silveira"
  )
```

```{r}
#| label: fig-internet-g3
ggplot(edu_achievement, aes(x = internet, y = G3, fill = internet)) +
  geom_boxplot(alpha = 0.7) +
  labs(
    title = "Distribution of Final Grades (G3) by Internet Access",
    x = "Internet Access",
    y = "Final Grade (G3)"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")

```
```{r}
#| label: health-g3-plot
ggplot(edu_achievement, aes(x = health, y = G3)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm") +
  labs(
    title = "Relationship Between Health Status and Final Grade (G3)",
    x = "Health Status (1 = Poor, 5 = Excellent)",
    y = "Final Grade (G3)"
  ) +
  theme_minimal(base_size = 14)
```

```{r}
ggplot(edu_achievement, aes(x = famrel, y = G3)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm") +
  labs(
    title = "Relationship Between Family Relationship Quality and Final Grade (G3)",
    x = "Family Relationship Quality (1 = Very Bad, 5 = Excellent)",
    y = "Final Grade (G3)"
  ) +
  theme_minimal(base_size = 14)
```


```{r}
#| label: fig-paid-g3
#| message: false
ggplot(edu_achievement, aes(x = paid, y = G3)) +
  geom_boxplot()
```


```{r}
#| label: fig-freetime-g3
#| message: false
ggplot(edu_achievement, aes(x = freetime, y = G3)) +
  geom_point()
```

```{r}
#| label: dem-vars-model-fit
dem_vars = c(
  "school",
  "sex",
  "age",
  "address",
  "famsize",
  "Pstatus",
  "Medu",
  "Fedu",
  "Mjob",
  "Fjob",
  "reason",
  "guardian"
)
formula_str_dem <- paste("G3 ~", paste(dem_vars, collapse = " + "))
rec_dem <- recipe(as.formula(formula_str_dem), data = edu_achievement)

dem_model <- linear_reg()

wf_dem <- workflow() |>
  add_recipe(rec_dem) |>
  add_model(dem_model)

dem_model <- fit(wf_dem, data = edu_achievement)

tidy(dem_model)
```

```{r}
#|label: study-vars-model-fit
study_vars = c(
  "studytime",
  "failures",
  "schoolsup",
  "famsup",
  "paid",
  "activities",
  "nursery",
  "higher",
  "internet",
  "romantic",
  "famrel",
  "freetime",
  "goout",
  "Dalc",
  "Walc",
  "health",
  "absences"
)
formula_str_study <- paste("G3 ~", paste(study_vars, collapse = " + "))
rec_study <- recipe(as.formula(formula_str_study), data = edu_achievement)

study_model <- linear_reg()

wf_study <- workflow() |>
  add_recipe(rec_study) |>
  add_model(study_model)

study_model <- fit(wf_study, data = edu_achievement)

tidy(study_model)
```

```{r}
#| label: glance
glance(dem_model)

glance(study_model)
```

We observe from the p-values of the variables in the two models, that several of them are not statistically significant for fitting. We will examine new models with variables having p-values lower than 0.05 (5e-2).

```{r}
#| label: reduced-dem-model
dem_vars_reduced = c(
  "sex",
  "age",
  "reason"
)
formula_str_dem_reduced <- paste("G3 ~", paste(dem_vars_reduced, collapse = " + "))
rec_dem_reduced <- recipe(as.formula(formula_str_dem_reduced), data = edu_achievement)

dem_model_reduced <- linear_reg()

wf_dem_reduced <- workflow() |>
  add_recipe(rec_dem_reduced) |>
  add_model(dem_model_reduced)

dem_model_reduced <- fit(wf_dem_reduced, data = edu_achievement)

tidy(dem_model_reduced)
```

```{r}
#| label: reduced-study-model
study_vars_reduced = c(
  "failures",
  "romantic",
  "goout"
)
formula_str_study_reduced <- paste("G3 ~", paste(study_vars_reduced, collapse = " + "))
rec_study_reduced <- recipe(as.formula(formula_str_study_reduced), data = edu_achievement)

study_model_reduced <- linear_reg()

wf_study_reduced <- workflow() |>
  add_recipe(rec_study_reduced) |>
  add_model(study_model_reduced)

study_model_reduced <- fit(wf_study_reduced, data = edu_achievement)

tidy(study_model_reduced)
```

```{r}
#| label: glance-reduced
glance(dem_model_reduced)

glance(study_model_reduced)
```

Based on the results of the multiple regression models, there does not appear to be any strong predictor of educational performance.